---
title: "Kvalitetskontroll del 2: compare"
author: ""
date: "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
    toc: true
    toc_float: true
---
For more info about the quality control, see [here](https://github.com/helseprofil/KHvalitetskontroll)!

```{r setup, include=FALSE}
# Global settings, do not change
knitr::opts_chunk$set(cache = F, echo = F)
source("https://raw.githubusercontent.com/helseprofil/KHvalitetskontroll/main/R/setup.R")
#source("../R/functions_step2.R")
```

# INPUT

**Data files loaded**
```{r echo = F}
## Load data
dfnew <- ReadFile(file = "HKR", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH", # KH or NH
                  folder = 2023) # "DATERT" or 4-digit year if file in NESSTAR-folder

dfold <- ReadFile(file = "HKR", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH",# KH or NH
                  folder = 2022) # DATERT" or 4-digit year if file in NESSTAR-folder
```
```{r}
####
# To get a list of variable names in the new KUBE, run the following code
names(dfnew)
names(dfold)
###

# All dimensions used to identify new or expired rows in the two data files
DIMENSIONS <- c("GEO", "AAR", "KJONN", "ALDER", "KODEGRUPPE")
VALUES <- c("TELLER", "RATE", "SMR", "MEIS", "RATE.n", "sumTELLER", "sumNEVNER")
```

# Flag all new rows in new KUBE

- All rows not existing in old cube should get newrow = 1
- Rows also existing in old cube should get newrow = 0

- Identify dimensions
    - Separate new/old dimensions
    - For new dimensions, all rows != 0 should be flagged
    - Map across old dimensions, all new levels flagged

1. 

```{r}
flag_new <- function(data1 = dfnew, 
                     data2 = dfold, 
                     dims = DIMENSIONS){
  
  # Identify dimensions present in new and old kube, separate into new and same dimensions
  dimnew <- names(data1[, names(data1) %in% dims, with = F])
  dimold <- names(data2[, names(data2) %in% dims, with = F])
  newdims <- dimnew[!dimnew %in% dimold]
  samedims <- dimnew[dimnew %in% dimold]
  
  # Initiate flagged version of new cube (newrow = 0/1) 
  dfnew_flag <<- copy(data1)[, newrow := 0]
  
  # set key for same and new dimensions, sorts the data
  setkeyv(dfnew_flag, c(samedims, newdims))
  
  # For same dimensions, flag any rows != 0 (i.e. not total numbers)
  
  
  
}


```




```{r}

```

# Create data for comparison

- dfnew_flagged (all rows flagged as new = 0/1), for further quality control
    - For new columns, only levels != 0 (i.e. not total) are flagged 
- dfnew_compare (all rows flagged as new = 1, and then all new columns, are removed
- dfold_compare (all expired columns, and expired levels, are removed)

```{r}
# Find comparable rows and columns, merge to comparecube

excludeyear <- function(data1 = dfnew,
                        data2 = dfold){
  
}

```

```{r}
compareNA_unequal <- function(v1,v2) {
  notsame <- case_when(abs(v1-v2) < 0.05 ~ 0,
                       is.na(v1) & is.na(v2) ~ 0,
                       TRUE ~ 1)
  return(notsame)
}
```

