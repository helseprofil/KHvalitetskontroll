---
title: "Kvalitetskontroll del 2: compare"
author: ""
date: "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
    toc: true
    toc_float: true
---
Version: 0.2 (01.11.2022). 

For more info about the quality control, see [here](https://github.com/helseprofil/KHvalitetskontroll)!

```{r setup, include=FALSE}
# Global settings, do not change
knitr::opts_chunk$set(cache = F, echo = F)
source("https://raw.githubusercontent.com/helseprofil/KHvalitetskontroll/main/R/setup.R")
```

# INPUT

**Data files loaded**
```{r echo = F}
## Load data
dfnew <- ReadFile(file = "ENEFHIB_2022-10-20-12-45", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH", # KH or NH
                  folder = "DATERT") # "DATERT" or 4-digit year if file in NESSTAR-folder

dfold <- ReadFile(file = "ENEFHIB", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH",# KH or NH
                  folder = 2022) # DATERT" or 4-digit year if file in NESSTAR-folder
```

```{r}
####
# To get a list of variable names in the new and old KUBE, run the following code
names(dfnew)
names(dfold)
###

# Define all dimensions used to identify new or expired rows in the two KUBEs
DIMENSIONS <- c("GEO", "AAR", "KJONN", "UTDANN", "INNVKAT")

# Define all value columns to be compared between the two KUBEs
VALUES <- c("TELLER", "RATE", "SMR", "sumTELLER", "sumNEVNER", "RATE.n", "SPVFLAGG")

# To save .csv-files of the flagged KUBEs, and/or the combined compareKUBE, use this option
# Available options: "dfnew_flag", "dfold_flag", and "compareKUBE"
# For no dumps, replace with "DUMPS <- NULL"
DUMPS <- NULL #c("dfnew_flag", "compareKUBE", "dfold_flag")

# To save files
PRODUCTIONYEAR <- 2023
```

```{r}
# To print input, do not change:
cat("DIMENSION columns: ", print_dim(DIMENSIONS), 
    "\nVALUE columns: ", print_dim(VALUES))
```
# Data formatting

- Create flagged versions of new and old KUBE, according to strata defined by the following dimensions: `r print_dim(DIMENSIONS)`
    - Flags all **new** rows in the new KUBE (strata not present in old KUBE)
    - Flags all **expired** rows in the old KUBE (strata not present in the new KUBE)
- Create combined data for comparisons, merged on the common dimensions in new and old KUBE
    - Removes any new or expired row
    - All value columns get the suffix "_new" or "_old"

```{r}
# No arguments needed, everything is defined in INPUT
FormatData()
```

# Time-series across dimensions

## KJONN
```{r}
library(ggplot2)

#' Title
#'
#' @param data defaults to dfnew
#' @param dim the dimension to group plot by
#' @param val values to plot at y-axis
#'
#' @return
#' @export
#'
#' @examples
timeseries_plot <- function(data = dfnew,
                            dim = "UTDANN",
                            val = c("sumTELLER", "sumNEVNER")) {
  # Extract AARl from AAR for plotting, and filter out country-level data
  plotdata <- copy(data)
  plotdata <-
    plotdata[, AARl := as.numeric(str_sub(AAR, 1L, 4L))][GEO == 0]
  
  # List of all dimensions that potentially should be checked, and the dimensions occurring in data
  alldims <- c("KJONN", "ALDER", "UTDANN", "INNVKAT", "LANDBAK")
  dimexist <- alldims[alldims %in% names(plotdata)]
  # list of dims where only total should be kept, and convert dimension of interest to factor
  totaldims <- dimexist[!dimexist %in% dim]
  plotdata[[dim]] <- as.factor(plotdata[[dim]])
  
  # Format data and create plot
  plotdata %>%
    filter(if_all(totaldims, ~ .x == 0)) %>%
    pivot_longer(cols = all_of(val),
                 names_to = "targetnumber",
                 values_to = "yval") %>%
    ggplot(aes(
      x = AARl,
      y = yval,
      color = .data[[dim]],
      group = .data[[dim]]
    )) +
    geom_point() +
    geom_line() +
    facet_grid(rows = vars(targetnumber),
               scales = "free_y", 
               switch = "y") + 
    labs(x = "Year (start year for period data)",
         y = NULL,
         title = paste0("Time series according to ", dim))
}
  
timeseries_plot() 
```

