---
title: "Kvalitetskontroll del 2: compare"
author: ""
date: "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
    toc: true
    toc_float: true
---
For more info about the quality control, see [here](https://github.com/helseprofil/KHvalitetskontroll)!

```{r setup, include=FALSE}
# Global settings, do not change
knitr::opts_chunk$set(cache = F, echo = F)
source("https://raw.githubusercontent.com/helseprofil/KHvalitetskontroll/main/R/setup.R")
#source("../R/functions_step2.R")
```

# INPUT

**Data files loaded**
```{r echo = F}
## Load data
dfnew <- ReadFile(file = "HKR", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH", # KH or NH
                  folder = 2023) # "DATERT" or 4-digit year if file in NESSTAR-folder

dfold <- ReadFile(file = "HKR", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH",# KH or NH
                  folder = 2022) # DATERT" or 4-digit year if file in NESSTAR-folder
```
```{r}
####
# To get a list of variable names in the new and old KUBE, run the following code
names(dfnew)
names(dfold)
###

# Define all dimensions used to identify new or expired rows in the two KUBE's
DIMENSIONS <- c("GEO", "AAR", "KJONN", "ALDER", "KODEGRUPPE")

# Define all value columns to be compared between the two KUBE's
VALUES <- c("TELLER", "RATE", "SMR", "MEIS", "RATE.n", "sumTELLER", "sumNEVNER")
```

# Flag all new rows in new KUBE

- Flags all **new** rows in the new KUBE, according to the following dimensions: `r print_dim(DIMENSIONS)`

```{r}
FlagNew()
```

# Flag all expired rows in old KUBE

- Flags all **expired** rows in the old KUBE, according to the following dimensions: `r print_dim(DIMENSIONS)`

```{r}
FlagOld()
```





```{r}
dimnew <- names(dfnew[, names(dfnew) %in% DIMENSIONS, with = F])
  dimold <- names(dfold[, names(dfold) %in% DIMENSIONS, with = F])
  commondims <- dimnew[dimnew %in% dimold]
  newdims <- dimnew[!dimnew %in% dimold]
  
  length(newdims)
```

# Create data for comparison

- dfnew_flagged (all rows flagged as new = 0/1), for further quality control
    - For new columns, only levels != 0 (i.e. not total) are flagged 
- dfnew_compare (all rows flagged as new = 1, and then all new columns, are removed
- dfold_compare (all expired columns, and expired levels, are removed)



