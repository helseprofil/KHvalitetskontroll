---
title: "Kvalitetskontroll del 2: compare"
author: ""
date: "`r Sys.Date()`"
output:
  html_document: 
    df_print: paged
    toc: true
    toc_float: true
---
For more info about the quality control, see [here](https://github.com/helseprofil/KHvalitetskontroll)!

```{r setup, include=FALSE}
# Global settings, do not change
knitr::opts_chunk$set(cache = F, echo = F)
source("https://raw.githubusercontent.com/helseprofil/KHvalitetskontroll/main/R/setup.R")
#source("../R/functions_step2.R")
```

# INPUT

**Data files loaded**
```{r echo = F}
## Load data
dfnew <- ReadFile(file = "HKR", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH", # KH or NH
                  folder = 2023) # "DATERT" or 4-digit year if file in NESSTAR-folder

dfold <- ReadFile(file = "HKR", # Matching, if >1 file found in folder, specify file name further
                  modus = "KH",# KH or NH
                  folder = 2022) # DATERT" or 4-digit year if file in NESSTAR-folder
```
```{r}
####
# To get a list of variable names in the new KUBE, run the following code
names(dfnew)
###

# All dimensions used to identify new or expired rows in the two data files
DIMENSIONS <- c("GEO", "AAR", "KJONN", "ALDER", "KODEGRUPPE")
```






```{r}
NewCols <- function(data1 = dfnew,
                    data2 = dfold){
  
  new <- names(data1 %>% 
                 select(!any_of(as.character(names(data2))))) 
  
  msg <- case_when(length(new) == 0 ~ "No new columns",
                   TRUE ~ paste0("New columns found: ", str_c(new, collapse = ", ")))
  
  cat(msg)

}


new <- NewCols()

dfnew %>% 
  select(-all_of(new))
```

# Create data for comparison

- dfnew_flagged (all rows flagged as new = 0/1), for further quality control
    - For new columns, only levels != 0 (i.e. not total) are flagged 
- dfnew_compare (all rows flagged as new = 1, and then all new columns, are removed
- dfold_compare (all expired columns, and expired levels, are removed)

```{r}
# Find comparable rows and columns, merge to comparecube

excludeyear <- function(data1 = dfnew,
                        data2 = dfold){
  
}

```

```{r}
compareNA_unequal <- function(v1,v2) {
  notsame <- case_when(abs(v1-v2) < 0.05 ~ 0,
                       is.na(v1) & is.na(v2) ~ 0,
                       TRUE ~ 1)
  return(notsame)
}
```

